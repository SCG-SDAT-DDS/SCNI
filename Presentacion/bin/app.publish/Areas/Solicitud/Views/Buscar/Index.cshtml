@using Datos
@using Datos.Recursos
@using Presentacion.Helpers
@using Sistema
@model Datos.DTO.Infraestructura.ViewModels.SolicitudViewModel

@{
    ViewBag.Title = "Buscar Solicitud";
}
@{ Html.EnableClientValidation(false); }
@using (Html.BeginForm())
{
    <div class="ibox bx-s">
        <div class="ibox-content p-l-20 p-r-10 bg-f">
            <div class="row">
                <div class="col-xs-12 p-all-0">
                    <div class="col-md-6">
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    @*@Html.LabelFor(m => m.Solicitud.FolioPago)*@
                                    <label for="Solicitud_FolioPago">Folio de Pago:</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.TextBoxFor(m => m.Solicitud.FolioPago, new {@class = "form-control input-sm"})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    @*@Html.LabelFor(m => m.Solicitud.Persona.Nombre)*@
                                    <label for="Solicitud_Persona_Nombre">Nombre:</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.TextBoxFor(m => m.Solicitud.Persona.Nombre, new {@class = "form-control input-sm", @maxlength = 50})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    @*@Html.LabelFor(m => m.Solicitud.Persona.RFC)*@
                                    <label for="Solicitud_Persona_RFC">RFC:</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.TextBoxFor(m => m.Solicitud.Persona.RFC, new {@class = "form-control input-sm uppercase", @maxlength = 13})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    <label for="Campo">Tipo</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.DropDownListFor(m => m.Solicitud.Medio, Listas.ObtenerListaTipoSolicitudes(), new {@class = "form-control input-sm"})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    <label>Mes / Año</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    <div class="col-md-7 p-all-0">
                                        @Html.DropDownListFor(m => m.FiltroMes, Listas.ObtenerListaMeses(true), new { @class = "form-control" })
                                    </div>
                                    <div class="col-md-5 m-0 p-all-0">
                                        @Html.DropDownListFor(m => m.FiltroAnio, Listas.ObtenerListaAños(true), new { @class = "form-control" })
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    <label for="Campo">Canceladas</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.CheckBoxFor(m => m.Solicitud.Cancelada)
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    <label for="Solicitud_Tipo">Tipo de Solicitud:</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.DropDownListFor(m => m.Solicitud.Tipo, Listas.ObtenerListaTipoSolicitud(), new { @class = "form-control" })
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    <label for="Solicitud_Entidad_Tipo">Tipo de Dependencia-Entidad:</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.DropDownListFor(m => m.Solicitud.Entidad.Tipo, Listas.ObtenerListaTipoEntidad(), new { @class = "form-control bg-e", @disabled = true })
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-horizontal">
                            <div class="form-group">
                                <div class="col-md-3 col-xs-12">
                                    <label for="Solicitud_Entidad_IDEntidad">Dependencia-Entidad:</label>
                                </div>
                                <div class="col-md-9 col-xs-12">
                                    @Html.EntidadDdl(m => m.Solicitud.Entidad.IDEntidad, Model.Solicitud.Entidad.Tipo, Model.Solicitud.Entidad.IDEntidad)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-12 m-t-10">
                        <div class="pull-right">
                            <a href="@Url.Action("Index")" class="btn-sm btn btn-info">Nueva búsqueda</a>
                            <a href="@Url.Action("Index", "Validar", new {@area = "Solicitud"})" class="btn btn-sm btn-default">Validar</a>
                            <input type="submit" class="btn btn-sm btn-primary" value="@General.Buscar"/>
                        </div>
                    </div>

                    <div class="col-xs-12 m-t-20 p-internos-0 m-b-5">
                        <div class="col-xs-6 bold">
                            @Html.DropDownListFor(m => m.TamanoPagina, Listas.ObtenerListaCantidadPagina())
                            @General.TamanoPagina
                        </div>
                        <div class="col-xs-6 text-right">
                            <label class="label label-success">
                                @General.Encontrados: @Model.TotalEncontrados
                            </label>
                        </div>
                    </div>

                    <div class="col-xs-12">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-striped" id="tblBusqueda">
                                <thead>
                                    <tr>
                                        <th>Fecha de Solicitud</th>
                                        <th>Folio de Pago</th>
                                        <th>RFC</th>
                                        <th>Nombre</th>
                                        <th>@Html.DisplayNameFor(m => m.Solicitud.Tipo)</th>
                                        <th class="text-center">@General.Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var solicitud in Model.Solicitudes)
                                    {
                                        <tr>
                                            <td>@solicitud.FechaSolicitud.ToString("dd/MM/yyyy")</td>
                                            <td>@solicitud.FolioPago</td>
                                            <td>@solicitud.Persona.RFC</td>
                                            <td>
                                                @solicitud.Persona.ApellidoP &nbsp;
                                                @solicitud.Persona.ApellidoM &nbsp;
                                                @solicitud.Persona.Nombre
                                            </td>
                                            <td>@Listas.ObtenerValorDeLista(Listas.ObtenerListaTipoSolicitud(), @solicitud.Tipo)</td>
                                            <td class="text-center">
                                                @{ var carta = solicitud.Carta.SingleOrDefault(); }
                                                
                                                @if (carta == null || carta.Estado == EstadosCarta.NoFirmada)
                                                {
                                                    @Html.ActionLinkCifrado(General.Modificar, "Index", "Registro", "Solicitud",
                                                        "btn btn-warning btn-circle", "fa fa-pencil",
                                                        new Dictionary<string, int> { { "idSolicitud", solicitud.IDSolicitud } })
                                                }

                                                @if (carta != null)
                                                {
                                                    <a class="btn btn-info btn-circle visualizar" href="#" title="Visualizar" data-id="@carta.IDCarta">
                                                        <i class="fa fa-search"></i>
                                                    </a>
                                                    <a class="btn btn-danger btn-circle imprimir"
                                                       href="@("https://docs.google.com/viewer?embedded=false&url=" + Model.UrlDescargarArchivo + "?idCarta=" + carta.IDCarta)"
                                                       target="_blank" title="Imprimir">
                                                        <i class="fa fa-print"></i>
                                                    </a>
                                                    <a class="btn btn-success btn-circle descargar" href="@Url.Action("Carta", "Descargar", new { Area = string.Empty, idCarta = carta.IDCarta })" id="descargar" title="Descargar">
                                                        <i class="fa fa-file-text-o"></i>
                                                    </a>
                                                }
                                                else
                                                {
                                                    @Html.ActionLinkCifrado("Validar", "DatosPersona", "Validar", "Solicitud", "btn btn-primary btn-circle", "fa fa-check", new Dictionary<string, int> { { "idSolicitud", solicitud.IDSolicitud } })
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div>
                            @Html.Partial("Controls/_Paginacion", Model)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Modales
{
    <div id="visualizarCarta" class="modal fade" role="dialog">
        <div class="modal-dialog" style="width: 760px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Visualizar Carta</h4>
                </div>
                <div class="modal-body">
                    <iframe id="ifCarta" runat="server" width='700px' height='450px' frameborder='0'
                            src=""></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@section FooterScripts
{
    <script type="text/javascript" src="/Scripts/jquery.tablesorter.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#Solicitud_Tipo").removeClass("input-validation-error");
            $("#Solicitud_Entidad_Tipo").removeClass("input-validation-error");
            $("#Solicitud_Entidad_IDEntidad").removeClass("input-validation-error");

            $('.visualizar').click(function () {
                $('#ifCarta').attr('height', ($(window).height() - 250) + "px");
                $('#visualizarCarta').modal('show');

                var url = '@Model.UrlDescargarArchivo' + '?idCarta=' + $(this).data('id');

                $('#ifCarta').attr('src', 'https://docs.google.com/viewer?embedded=true&url=' + url);
            });

            $('#visualizarCarta').on('hidden.bs.modal', function () {
                $('#ifCarta').attr('src', '');
            });

            $("#tblBusqueda").tablesorter();

            $(function () {
                $("#Solicitud_Tipo").on("change", function () {
                    if ($(this).val() <= 1) {
                        $("#Solicitud_Entidad_Tipo").attr("disabled", "disabled");
                        $("#Solicitud_Entidad_Tipo").val($("#Solicitud_Entidad_Tipo option:first").val());
                        $("#Solicitud_Entidad_IDEntidad").empty();
                        $("#Solicitud_Entidad_IDEntidad").attr("disabled", "disabled");
                        $("#Solicitud_Entidad_Tipo").addClass("bg-e");
                    } else {
                        $("#Solicitud_Entidad_Tipo").removeAttr("disabled");
                        $("#Solicitud_Entidad_Tipo").removeClass("bg-e");
                    }
                });
            });

            if ($("#Solicitud_Tipo option:last").is(":selected")) {
                $("#Solicitud_Entidad_Tipo").removeAttr("disabled");
                $("#Solicitud_Entidad_Tipo").removeClass("bg-e");
                if (!$("#Solicitud_Entidad_Tipo option:first").is(":selected")) {
                    $.ajax({
                        data: "{Tipo: " + $("#Solicitud_Entidad_Tipo").val() + "}",
                        dataType: "json",
                        contentType: "application/json",
                        type: "POST",
                        url: '/SolicitudWeb/ObtenerEntidades',
                        beforeSend: function () {
                            MostrarMensajeCargando($("#Solicitud_Entidad_IDEntidad"));
                        },
                        success: function (data) {
                            CargarDdl($("#Solicitud_Entidad_IDEntidad"), data);
                            CerrarMensajeCargando();
                        },
                        error: function (error) {
                            CerrarMensajeCargando();
                        }
                    });
                }
            }

        });
    </script>
}